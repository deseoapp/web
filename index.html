<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deseo - Plataforma de Micro-Deseos</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="availability-styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Mapbox GL JS -->
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.js"></script>
</head>
<body>
    <!-- Contenedor principal del layout -->
    <div class="app-container">
        <!-- Sidebar izquierdo -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <i class="fas fa-compass"></i>
                    <h1>Deseos</h1>
                </div>
                <button class="sidebar-toggle" id="sidebarToggle">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
            <nav class="main-nav hidden">
                <ul>
                    <li><a href="#" id="authButton"><i class="fas fa-user"></i> Iniciar Sesión</a></li> <!-- Botón de Auth -->
                    <li><a href="#"><i class="fas fa-home"></i> Inicio</a></li>
                    <li><a href="wallet.html"><i class="fas fa-wallet"></i> Billetera</a></li>
                    <li><a href="#"><i class="fas fa-cog"></i> Configuración</a></li>
                    <li><a href="#" id="themeToggle"><i class="fas fa-moon"></i> Tema</a></li> <!-- Botón de alternar tema -->
                </ul>
            </nav>

            <div class="search-bar">
                <input type="text" placeholder="Buscar deseos..." id="wishSearchInput">
                <button><i class="fas fa-search"></i></button>
            </div>

            <div class="filters">
                <div class="filter-group">
                    <span>Categoría:</span>
                    <select id="categoryFilterSidebar">
                        <option value="">Todas</option>
                        <option value="comida">Comida</option>
                        <option value="servicios">Servicios</option>
                        <option value="compras">Compras</option>
                        <option value="transporte">Transporte</option>
                        <option value="entretenimiento">Entretenimiento</option>
                    </select>
                </div>
                <div class="filter-group">
                    <span>Precio máximo:</span>
                    <input type="range" id="priceFilterSidebar" min="0" max="1000000" value="1000000">
                    <span id="priceValueSidebar">$1.000.000</span>
                </div>
                <button class="btn-filter" id="applySidebarFiltersBtn"><i class="fas fa-filter"></i> Aplicar Filtros</button>
            </div>

            <div class="wish-list" id="wishList">
                <!-- Los items de deseos se cargarán dinámicamente aquí -->
                <div class="wish-item">
                    <div class="wish-logo"><i class="fas fa-utensils"></i></div>
                    <div class="wish-info">
                        <h3>Comprar café en Starbucks</h3>
                        <p>$8 • Comida</p>
                    </div>
                    <div class="wish-actions">
                        <i class="fas fa-heart"></i>
                    </div>
                </div>
                <div class="wish-item">
                    <div class="wish-logo"><i class="fas fa-dog"></i></div>
                    <div class="wish-info">
                        <h3>Pasear a mi perro</h3>
                        <p>$15 • Servicios</p>
                    </div>
                    <div class="wish-actions">
                        <i class="fas fa-heart"></i>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Área del mapa -->
        <main class="map-area">
            <div id="map" class="mapbox-map"></div>

            <!-- Botón flotante para marcar disponibilidad -->
            <button class="floating-btn" id="floatingAvailabilityBtn">
                <i class="fas fa-user-check"></i>
            </button>

            <!-- Tarjeta de detalles del perfil (oculta por defecto) -->
            <div class="profile-details-card" id="profileDetailsCard">
                <button class="close-details-card" onclick="document.getElementById('profileDetailsCard').classList.remove('active');">
                    <i class="fas fa-times"></i>
                </button>
                <div class="card-header">
                    <div class="profile-avatar"><img src="" alt="" id="profileDetailsCardAvatar"></div>
                    <div class="profile-info-small">
                        <h3 id="profileDetailsCardName"></h3>
                        <p id="profileDetailsCardCategoryPrice"></p>
                    </div>
                    <div class="profile-meta">
                        <span class="location"><i class="fas fa-map-marker-alt"></i> Ubicación</span>
                        <span class="price-tag" id="profileDetailsCardPrice"></span>
                    </div>
                </div>
                <div class="card-body">
                    <h4 id="profileDetailsCardDescription"></h4>
                    <p class="profile-age" id="profileDetailsCardAge"></p>
                    <button class="btn-primary" id="contactProfileBtnCard">Contactar</button>
                    <button class="btn-secondary" id="viewChatBtnCard" style="display: none;">Ver Chat</button>
                </div>
            </div>
        </main>
    </div>

    <!-- Notificaciones y Modales (mantener existentes) -->
    <div class="notification-container" id="notificationContainer"></div>

    <!-- Modal de Autenticación (se reemplazará por Clerk UI) -->
    <div id="authContainer" class="modal"></div> <!-- Aseguramos que sea un modal para que Clerk pueda renderizar -->

    <!-- Modal para marcar disponibilidad -->
    <div class="modal" id="availabilityModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-user-check"></i> Marcar Disponibilidad</h2>
                <button class="close-btn" id="closeAvailabilityModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="availability-section">
                    <div class="availability-toggle">
                        <h3>¿Estás disponible?</h3>
                        <div class="toggle-switch">
                            <input type="checkbox" id="availabilityToggle" class="toggle-input">
                            <label for="availabilityToggle" class="toggle-label">
                                <span class="toggle-slider"></span>
                                <span class="toggle-text">Disponible</span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="category-selection" id="categorySelection" style="display: none;">
                        <h3>Selecciona tu categoría:</h3>
                        <div class="category-grid">
                            <div class="category-card" data-category="escort">
                                <i class="fas fa-female"></i>
                                <span>Escort</span>
                            </div>
                            <div class="category-card" data-category="gigolo">
                                <i class="fas fa-male"></i>
                                <span>Gigolo</span>
                            </div>
                            <div class="category-card" data-category="masajes">
                                <i class="fas fa-spa"></i>
                                <span>Masajes</span>
                            </div>
                            <div class="category-card" data-category="trans">
                                <i class="fas fa-transgender"></i>
                                <span>Trans</span>
                            </div>
                            <div class="category-card" data-category="chat">
                                <i class="fas fa-comments"></i>
                                <span>Chat</span>
                            </div>
                            <div class="category-card" data-category="live">
                                <i class="fas fa-video"></i>
                                <span>Live</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn-secondary" id="cancelAvailability">
                        Cancelar
                    </button>
                    <button type="button" class="btn-danger" id="markUnavailable" style="display: none;">
                        <i class="fas fa-times"></i>
                        No Disponible
                    </button>
                    <button type="button" class="btn-primary" id="submitAvailability">
                        <i class="fas fa-check"></i>
                        Estoy Disponible
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para detalles del deseo (Este modal ahora es la tarjeta flotante, su uso directo debería ser mínimo) -->
    <div class="modal" id="wishDetailsModal" style="display:none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="wishDetailsTitle"></h2>
                <button class="close-btn" id="closeDetailsModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="wish-details">
                    <p id="wishDetailsDescription"></p>
                    <div class="wish-meta">
                        <span class="price" id="wishDetailsPrice"></span>
                        <span class="category" id="wishDetailsCategory"></span>
                        <span class="location" id="wishDetailsLocation"></span>
                    </div>
                    <div class="wish-actions">
                        <button class="btn-secondary" id="viewDetailsBtn">Ver Detalles</button>
                        <button class="btn-primary" id="acceptWishBtn">Aceptar Deseo</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de chat privado -->
    <div class="modal" id="privateChatModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Chat con <span id="chatUserName"></span></h2>
                <button class="close-btn" id="closeChatModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="private-chat-container">
                    <div class="chat-messages" id="privateChatMessages">
                        <!-- Mensajes del chat se generarán dinámicamente -->
                    </div>
                    <div class="chat-input">
                        <input type="text" id="privateChatInput" placeholder="Escribe tu mensaje...">
                        <button id="sendPrivateMessage">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
                <div class="chat-actions">
                    <button class="btn-success" id="completeWishBtn">Marcar como Completado</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de calificación -->
    <div class="modal" id="ratingModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Califica la Experiencia</h2>
                <button class="close-btn" id="closeRatingModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="rating-container">
                    <div class="rating-status">
                        <h3>¿Se cumplió el deseo?</h3>
                        <div class="status-buttons">
                            <button class="btn-success" id="fulfilledBtn">Cumplido</button>
                            <button class="btn-danger" id="unfulfilledBtn">No Cumplido</button>
                        </div>
                    </div>
                    <div class="star-rating">
                        <h3>Calificación (1-5 estrellas)</h3>
                        <div class="stars" id="starRating">
                            <i class="fas fa-star" data-rating="1"></i>
                            <i class="fas fa-star" data-rating="2"></i>
                            <i class="fas fa-star" data-rating="3"></i>
                            <i class="fas fa-star" data-rating="4"></i>
                            <i class="fas fa-star" data-rating="5"></i>
                        </div>
                    </div>
                    <div class="comment-section">
                        <h3>Comentario (opcional)</h3>
                        <textarea id="ratingComment" placeholder="Cuéntanos sobre tu experiencia..."></textarea>
                    </div>
                    <button class="btn-primary" id="submitRating">Enviar Calificación</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de filtros (mantener tal cual, ya adaptado a deseos en script-mapbox.js) -->
    <div class="modal" id="filterModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Filtrar Deseos</h2>
                <button class="close-btn" id="closeFilterModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="filter-container">
                    <div class="filter-group">
                        <label>Precio máximo:</label>
                        <input type="range" id="priceFilter" min="0" max="1000" value="1000">
                        <span id="priceValue">$1000</span>
                    </div>
                    <div class="filter-group">
                        <label>Categoría:</label>
                        <select id="categoryFilter">
                            <option value="">Todas las categorías</option>
                            <option value="comida">Comida</option>
                            <option value="transporte">Transporte</option>
                            <option value="entretenimiento">Entretenimiento</option>
                            <option value="servicios">Servicios</option>
                            <option value="compras">Compras</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Distancia:</label>
                        <select id="distanceFilter">
                            <option value="5">5 km</option>
                            <option value="10">10 km</option>
                            <option value="25">25 km</option>
                            <option value="50">50 km</option>
                        </select>
                    </div>
                    <button class="btn-primary" id="applyFilters">Aplicar Filtros</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="config.js?v=3.0&t=2024-01-15"></script>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <script src="script-mapbox.js" onload="console.log('✅ script-mapbox.js loaded successfully')" onerror="console.error('❌ Failed to load script-mapbox.js')"></script>
    
    <!-- Clerk SDKs -->
    <script
    async
    crossorigin="anonymous"
    data-clerk-publishable-key="pk_test_bWVycnktamF5LTExLmNsZXJrLmFjY291bnRzLmRldiQ"
    src="https://cdn.jsdelivr.net/npm/@clerk/clerk-js@latest/dist/clerk.browser.js">
    </script>


    <!-- Inicialización GLOBAL de la aplicación y Clerk -->
    <script type="module">
        window.addEventListener('load', async function () {
            console.log('🏁 Window fully loaded. Initializing Deseo App and Clerk...');

            // Esperar un momento para asegurar que todos los scripts estén cargados
            await new Promise(resolve => setTimeout(resolve, 100));

            // Verificar que DeseoApp esté disponible
            if (typeof DeseoApp === 'undefined') {
                console.error('❌ DeseoApp class not found. Script loading issue.');
                console.log('Available globals:', Object.keys(window).filter(k => k.includes('Deseo') || k.includes('App')));
                return;
            }

            // Inicializar la aplicación principal
            if (!window.deseoApp) {
                window.deseoApp = new DeseoApp();
                console.log('✨ DeseoApp instance created.');
            } else {
                console.log('DeseoApp ya estaba inicializada.');
            }
            
            // Función para esperar a que Clerk esté disponible
            async function waitForClerk() {
                let attempts = 0;
                const maxAttempts = 50; // 5 segundos máximo
                
                while (attempts < maxAttempts) {
                    if (window.Clerk) {
                        console.log('✅ Clerk SDK detected after', attempts * 100, 'ms');
                        return true;
                    }
                    await new Promise(resolve => setTimeout(resolve, 100));
                    attempts++;
                }
                return false;
            }
            
            // Inicializar Clerk
            if (CONFIG.CLERK.enabled) {
                console.log('⏳ Waiting for Clerk SDK to load...');
                const clerkAvailable = await waitForClerk();
                
                if (clerkAvailable) {
                    try {
                        await window.Clerk.load();
                        console.log('✅ Clerk SDK loaded successfully.');

                        window.Clerk.addListener(({ user }) => {
                            if (user) {
                                console.log('👤 Usuario autenticado con Clerk:', user);
                                if (window.deseoApp) {
                                    window.deseoApp.handleClerkSignIn(user);
                                }
                            } else {
                                console.log('👤 Usuario no autenticado con Clerk');
                                if (window.deseoApp) {
                                    window.deseoApp.handleClerkSignOut();
                                }
                            }
                        });

                        // Verificar el estado inicial después de que Clerk se cargue
                        if (window.Clerk.user && window.deseoApp) {
                            window.deseoApp.handleClerkSignIn(window.Clerk.user);
                        } else if (window.deseoApp) {
                            console.log('Clerk Ready, pero no hay usuario autenticado. Esperando interacción.');
                            window.deseoApp.handleClerkSignOut(); // Asegurar que la UI se actualice al estado de no logueado
                        }
                        
                        // Forzar actualización de UI para el botón de auth después de que Clerk se haya cargado
                        if (window.deseoApp) {
                            window.deseoApp.updateAuthUI();
                        }

                    } catch (err) {
                        console.error("❌ Error loading Clerk:", err);
                    }
                } else {
                    console.error("❌ Clerk SDK no se pudo cargar después de 5 segundos");
                }
            } else {
                console.log("Clerk no está habilitado.");
            }

            // Llamadas iniciales que dependen de DeseoApp y el DOM
            if (window.deseoApp) {
                window.deseoApp.renderAvailableProfilesInSidebar();

                // Inicializar listeners de filtros del sidebar
                const priceFilterSidebar = document.getElementById('priceFilterSidebar');
                const priceValueSidebar = document.getElementById('priceValueSidebar');
                if (priceFilterSidebar && priceValueSidebar) {
                    priceFilterSidebar.addEventListener('input', (e) => {
                        priceValueSidebar.textContent = `$${e.target.value}`;
                    });
                    priceValueSidebar.textContent = `$${priceFilterSidebar.value}`;
                }
            }

            console.log('🗺️ Deseo App con Mapbox cargada exitosamente!');
            console.log('📱 Plataforma de micro-deseos con mapa real');
            console.log('🤖 IA simulada activa');
            console.log('🗺️ Mapa interactivo de Mapbox funcionando');
            console.log('💬 Sistema de chat implementado');
            console.log('⭐ Sistema de calificaciones activo');
            console.log('🔥 Sistema de autenticación implementado');
        });
    </script>
    
</body>